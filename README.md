# 🧍 AI坐姿检测系统

一个基于计算机视觉和姿态识别的智能坐姿检测系统，使用MediaPipe和Streamlit构建，能够实时监测用户的坐姿状态并提供即时纠正建议。支持3D姿态检测，提供更精准的坐姿分析。

## 🎯 项目特色

- **3D姿态检测**：使用MediaPipe进行高精度的3D人体姿态识别
- **智能坐姿分析**：自动检测脖子前倾、脊柱弯曲等常见坐姿问题
- **双模式支持**：实时摄像头检测和视频文件分析两种模式
- **精确角度监测**：实时显示脖子前倾角度和脊柱弯曲角度
- **现代化Web界面**：基于Streamlit的专业用户界面
- **可视化反馈**：骨骼连线、角度标注、彩色提示等多重视觉反馈

## 🚀 功能特性

### 📹 实时检测模式
- **实时姿态识别**：通过摄像头实时捕获和分析用户姿态
- **3D角度计算**：基于3D坐标计算精确的颈部和脊柱角度
- **即时反馈**：实时显示坐姿状态和纠正建议
- **WebRTC支持**：低延迟的视频流处理

### 📁 视频分析模式
- **批量视频处理**：支持上传视频文件进行详细分析
- **进度显示**：实时显示视频处理进度
- **格式兼容**：支持MP4、AVI、MOV、MKV多种格式
- **结果下载**：可下载标注后的分析视频

### 🧮 核心检测算法
- **脖子前倾检测**：计算鼻-肩中心-髋中心的3D夹角
- **脊柱弯曲检测**：计算肩中心-髋中心-垂直向上的前倾角度
- **3D坐标系统**：利用MediaPipe的3D关键点提高检测鲁棒性
- **脊柱线绘制**：可视化脊柱状态，便于用户理解

### 🎨 可视化系统
- **骨骼连线**：蓝色线条显示身体关键点连接
- **角度标注**：实时显示关键角度数值
- **彩色反馈**：使用不同颜色表示坐姿严重程度
- **中文字体支持**：完整的中文显示界面

## 📋 系统要求

- **Python 3.8+** (推荐3.9)
- **摄像头设备** (实时检测模式)
- **操作系统**：Windows/Linux/macOS
- **浏览器**：Chrome/Firefox/Safari (支持WebRTC)

## 🛠️ 安装指南

### 1. 安装依赖
```bash
pip install -r requirements.txt
```

### 2. 运行应用
```bash
# Windows用户 - 使用批处理文件
start.bat          # 快速启动

# 手动启动方式
streamlit run 坐姿检测.py
```

### 4. 访问应用
启动后浏览器会自动打开，或手动访问：`http://localhost:8501`

## 📦 项目结构

```
坐姿检测/
├── 坐姿检测.py                   # 主应用入口 - Streamlit界面
├── video_processor.py           # 视频分析处理器 - 视频文件处理
├── frame_instance.py            # 帧实例类 - 单帧姿态检测和可视化
├── posture_process.py           # 坐姿处理核心 - 3D角度计算算法
├── utils.py                     # 工具函数 - 角度计算、绘制等
├── requirements.txt             # 项目依赖包列表
├── start.bat                    # Windows启动脚本
├── incorrect.wav                # 坐姿错误提示音频
├── reset_counters.wav           # 重置计数器音频
├── output_live.flv              # 实时检测输出视频文件
└── venv/                        # Python虚拟环境目录
```

## 🔧 核心组件详解

### 🧍 FrameInstance类 (`frame_instance.py`)
**职责**：单帧图像处理和姿态检测可视化

**核心功能**：
- **3D姿态检测**：使用MediaPipe获取33个人体关键点的3D坐标
- **中心点计算**：计算双肩中心(`shldr_center`)和双髋中心(`hip_center`)
- **角度测量**：支持任意三点间的角度计算和可视化
- **绘图系统**：骨骼连线、关键点标注、角度弧线绘制
- **中文支持**：完整的中文文本渲染功能

**关键方法**：
- `get_angle_and_draw()` - 计算并可视化三点角度
- `get_spine_angle()` - 计算脊柱前倾角度
- `draw_spine_line()` - 绘制脊柱可视化线条
- `__convert_3d_to_2d__()` - 3D坐标到2D屏幕坐标转换

### ⚙️ posture_process函数 (`posture_process.py`)
**职责**：坐姿检测的核心算法逻辑

**检测算法**：
1. **脖子前倾检测**：计算鼻-肩中心-髋中心的3D夹角
2. **脊柱弯曲检测**：计算肩中心-髋中心-垂直向上的前倾角度
3. **分级反馈系统**：根据角度阈值提供三级反馈（良好/轻微/严重）
4. **实时显示**：角度数值和状态信息的屏幕显示

**阈值设置**：
- 脖子前倾：严重(<130°) → 轻微(130°-140°) → 良好(≥140°)
- 脊柱前倾：良好(≤10°) → 轻微(10°-20°) → 严重(>20°)

### 📹 VideoProcessor类 (`video_processor.py`)
**职责**：视频文件批处理和统计分析

**功能模块**：
- **多格式支持**：MP4/AVI/MOV/MKV视频格式处理
- **进度追踪**：实时显示视频处理进度条
- **统计分析**：生成坐姿质量统计报告
- **格式转换**：自动转换为Web兼容的视频格式
- **批量检测**：对视频每一帧进行坐姿分析

### 🛠️ 工具模块 (`utils.py`)
**职责**：底层算法和辅助函数

**核心工具**：
- **角度计算**：`find_angle()` - 精确的三点角度计算
- **关键点处理**：`get_landmark_features()` - MediaPipe关键点提取
- **绘图函数**：`draw_text()`, `draw_rounded_rect()` - 中文界面支持
- **MediaPipe初始化**：`get_mediapipe_pose()` - 姿态检测器配置
- **颜色定义**：完整的颜色常量系统

## 🎮 使用指南

### 📹 实时检测模式

**步骤说明**：
1. **启动应用**：运行`start.bat`启动Streamlit应用
2. **选择标签**：点击"📹 实时检测"选项卡
3. **摄像头授权**：允许浏览器访问摄像头（首次使用时）
4. **调整位置**：
   - 保持上半身完整可见
   - 建议侧面坐姿，检测效果更佳
   - 确保光线充足，避免背光
5. **开始检测**：系统自动开始实时姿态分析
6. **查看反馈**：
   - **蓝色线条**：身体骨骼连接
   - **黄色圆点**：关键关节位置
   - **角度数值**：实时显示脖子前倾和脊柱弯曲角度
   - **彩色提示框**：坐姿状态反馈
7. **调整坐姿**：根据屏幕提示调整到正确坐姿

**界面元素说明**：
- **脊柱线**：连接肩中心和髋中心的蓝色线条
- **角度弧线**：显示关键角度的可视化弧线
- **状态提示**：分为"良好"、"轻微"、"严重"三个级别
- **视频录制**：可录制检测过程并下载

### 📁 视频分析模式

**操作流程**：
1. **切换标签**：点击"📁 视频分析"选项卡
2. **上传视频**：
   - 支持格式：MP4、AVI、MOV、MKV
   - 建议视频时长：10秒-5分钟
   - 文件大小：<100MB
3. **开始分析**：点击"🚀 开始分析"按钮
4. **处理过程**：
   - 显示实时进度条
   - 逐帧进行坐姿检测
   - 自动绘制标注信息
5. **查看结果**：
   - **分析视频**：带有完整标注的处理后视频
   - **统计报告**：
     - 总帧数和良好帧数
     - 坐姿质量百分比
     - 详细分类统计（良好/轻微低头/严重低头等）
   - **可视化效果**：
     - 身体骨骼连线
     - 关键点标注
     - 实时角度显示
     - 坐姿状态反馈
6. **下载保存**：点击下载按钮保存分析结果

**最佳实践**：
- 视频中人物应保持相对静止
- 确保上半身清晰可见
- 避免遮挡和复杂背景
- 建议侧面视角以获得最佳检测效果

## ⚙️ 技术参数配置

### 📐 角度阈值设置

#### 脖子前倾检测（鼻-肩中心-髋中心 3D夹角）
- **良好状态**：≥ 140°
  - 显示："头部姿势良好"
  - 颜色：绿色背景
- **轻微前倾**：130° - 140°
  - 显示："轻微低头，注意调整"
  - 颜色：黄色背景
- **严重前倾**：< 130°
  - 显示："严重低头！请抬起头"
  - 颜色：红色背景

#### 脊柱弯曲检测（肩中心-髋中心-垂直向上 夹角）
- **良好状态**：≤ 10°
  - 显示："脊柱姿势良好"
  - 颜色：绿色背景
- **轻微前倾**：10° - 20°
  - 显示："轻微前倾，注意坐姿"
  - 颜色：黄色背景
- **严重前倾**：> 20°
  - 显示："严重前倾！请挺直腰背"
  - 颜色：红色背景

#### 综合坐姿评估
- **坐姿良好**：脖子前倾角度 ≥ 115° 且 脊柱前倾角度 ≤ 10°
- **需要调整**：不满足上述任一条件

### 🎨 可视化参数

#### 颜色配置
- **骨骼线条**：浅蓝色 (`light_blue`) - 4px粗细
- **关键点**：黄色 (`yellow`) - 7px半径圆点
- **角度弧线**：白色 (`white`)
- **文本颜色**：根据状态动态调整

#### 字体设置
- **字体类型**：黑体 (`simhei.ttf`)
- **基础字号**：20px
- **比例缩放**：0.6-0.8
- **圆角矩形**：8px圆角

### 📊 MediaPipe配置
- **模型复杂度**：1（平衡精度和性能）
- **检测置信度**：0.5
- **跟踪置信度**：0.5
- **平滑处理**：启用
- **关键点数量**：33个全身关键点

## 🔬 检测原理详解

### 🧮 3D姿态检测流程

#### 1. 图像获取与预处理
- **实时模式**：通过WebRTC获取摄像头视频流
- **视频模式**：读取上传的视频文件
- **色彩转换**：BGR → RGB格式转换
- **坐标归一化**：图像坐标映射到[0,1]范围

#### 2. MediaPipe关键点识别
- **输入**：RGB图像帧
- **模型**：BlazePose人体姿态检测模型
- **输出**：33个关键点的3D坐标 (x, y, z)
- **精度**：实时检测，低延迟处理

#### 3. 关键点坐标处理
```python
# 核心关键点计算
coord['nose'] = 鼻子3D坐标
coord['shldr_center'] = (左肩 + 右肩) / 2  # 双肩中心点
coord['hip_center'] = (左髋 + 右髋) / 2    # 双髋中心点
```

#### 4. 3D角度计算算法

##### 脖子前倾角度
- **定义**：鼻-肩中心-髋中心 三点的3D夹角
- **计算方法**：
  ```python
  angle = arccos( (向量1·向量2) / (|向量1|×|向量2|) )
  向量1 = 鼻子坐标 - 肩中心坐标
  向量2 = 髋中心坐标 - 肩中心坐标
  ```

##### 脊柱前倾角度  
- **定义**：肩中心-髋中心-垂直向上 三点的夹角
- **垂直点计算**：`hip_center + (0, -0.1, 0)` (Y轴向上为负)
- **物理意义**：身体相对于垂直轴的倾斜程度

#### 5. 坐姿状态评估
- **分级判断**：根据角度阈值确定坐姿质量
- **综合评估**：结合颈部和脊柱状态
- **实时反馈**：生成文字提示和可视化效果

#### 6. 坐标转换与绘制
- **3D→2D转换**：归一化坐标转换为屏幕像素坐标
- **可视化绘制**：
  - 骨骼连线：OpenCV线条绘制
  - 角度弧线：椭圆弧线绘制
  - 关键点：圆形标记
  - 文本：中文渲染

### 📊 检测精度影响因素

#### 正面因素
- ✅ **侧面视角**：提供更清晰的身体轮廓
- ✅ **光线充足**：提高关键点检测精度
- ✅ **完整上半身**：确保关键点完整可见
- ✅ **适当距离**：避免过近或过远的拍摄距离

#### 负面因素  
- ❌ **严重遮挡**：关键点被遮挡导致检测失败
- ❌ **复杂背景**：背景干扰影响姿态识别
- ❌ **光线不足**：降低图像质量，影响检测精度
- ❌ **极端角度**：完全正面或背面视角效果较差

### 🧮 数学原理

#### 向量夹角公式
```
cos(θ) = (a·b) / (|a| × |b|)
θ = arccos(cos(θ))
```

#### 3D到2D投影
```
x_2d = x_3d × frame_width
y_2d = y_3d × frame_height
z_3d = 深度信息 (用于3D计算)
```

#### 椭圆弧线绘制算法
```python
# 计算两个向量的角度
angle1 = atan2(v1_y, v1_x)
angle2 = atan2(v2_y, v2_x)
# 绘制角度弧线
cv2.ellipse(img, center, axes, angle, startAngle, endAngle, color, thickness)
```


## 📝 依赖包详情

### 核心依赖
- **mediapipe** (>=0.10.0,<0.11.0) - Google姿态识别库，3D人体关键点检测
- **opencv-python-headless** (>=4.5.0,<4.9.0) - 计算机视觉处理，图像绘制
- **numpy** (>=1.21.0,<1.25.0) - 数值计算，矩阵运算

### Web框架
- **streamlit** (>=1.10.0,<2.0.0) - Web应用框架，用户界面
- **streamlit-webrtc** (>=0.44.0) - 实时视频流处理，WebRTC支持

### 音视频处理  
- **av** (>=10.0.0) - 音视频编解码，视频录制
- **simpleaudio** (>=1.0.4) - 音频播放支持

### 可视化与界面
- **altair** (>=4.0.0,<5.0.0) - 数据可视化（统计图表）
- **Pillow** (>=9.0.0) - 图像处理，中文字体支持
- **pandas** (>=1.3.0) - 数据分析，统计报告生成

### 协议支持
- **protobuf** (>=3.20.0,<4.0.0) - MediaPipe通信协议

---

## 🔧 故障排除

### 常见问题

#### 📹 摄像头问题
- **问题**：摄像头无法启动或黑屏
- **解决**：
  - 检查浏览器摄像头权限
  - 确认其他应用未占用摄像头
  - 尝试刷新页面或重启浏览器

#### 🎯 检测不准确
- **问题**：角度计算错误或关键点检测失败
- **解决**：
  - 调整坐姿，确保侧面视角
  - 改善光线条件，避免背光
  - 确保上半身完整可见
  - 清理背景，减少干扰

#### 📁 视频处理失败
- **问题**：视频上传后处理失败
- **解决**：
  - 检查视频格式（支持MP4/AVI/MOV/MKV）
  - 确认视频文件未损坏
  - 减小视频文件大小（<100MB）
  - 尝试转换视频格式

#### 🐛 应用启动错误
- **问题**：Streamlit应用无法启动
- **解决**：
  - 检查Python版本（需要3.8+）
  - 确认所有依赖已正确安装
  - 检查端口8501是否被占用
  - 查看终端错误信息进行调试

### 性能优化建议

#### 🖥️ 硬件要求
- **CPU**：双核2.0GHz以上（推荐四核）
- **内存**：4GB以上（推荐8GB）
- **显卡**：支持WebGL的显卡（推荐独立显卡）

#### ⚡ 优化设置
- **降低分辨率**：减少计算负载
- **调整检测频率**：平衡精度和性能
- **关闭其他应用**：释放系统资源


---

**💡 使用提示**：为了获得最佳检测效果，建议在光线充足的环境下使用，保持侧面坐姿，确保上半身清晰可见。如有疑问，请参考故障排除部分或提交Issue。
